name: CI-CD

on: [push]

jobs:
  test:  
    runs-on: ubuntu-latest
    steps:
    - name: clone repo
      uses: actions/checkout@v1
    
    - name: make and load dotenv file
      run: echo "${{ secrets.DOT_ENV }}" > .env
      
    - name: init database
      run: |
        source .env
        docker pull postgres
        docker run --name test_postgres -e POSTGRES_PASSWORD=$TEST_DB_PASS -e POSTGRES_DB=$TEST_DB_NAME -p $TEST_DB_PORT:5432 -d postgres
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    
    - name: install python requirements
      run: pip install -r requirements/dev.txt

    - name: run tests
      run: pytest tests/

  deploy:  
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Connect to server and pull
        run: |
          sshpass -p ${{ secrets.SERVER_PASS }} ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} -p ${{ secrets.SERVER_PORT }} << EOF
          cd Pyaroshnaya-backend
          git pull
